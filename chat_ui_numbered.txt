0001: """Streamlit Chat UI
0002: 
0003: åŸºæœ¬çš„ãªãƒãƒ£ãƒƒãƒˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã€‚
0004: TDD Green Phase: æœ€å°é™ã®å‹•ä½œã™ã‚‹UIã€‚
0005: 
0006: è¨­è¨ˆåŸå‰‡:
0007: - å˜ä¸€è²¬ä»»ã®åŸå‰‡ï¼ˆSRPï¼‰: UIè¡¨ç¤ºã®ã¿
0008: - é–¢å¿ƒã®åˆ†é›¢: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¯Orchestratorã«å§”è­²
0009: - ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§: ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’æ˜ç¤ºçš„ã«ç®¡ç†
0010: """
0011: 
0012: import streamlit as st
0013: 
0014: from src.infrastructure.di_container import DIContainer
0015: from src.presentation.components.file_browser import render_file_browser
0016: from src.presentation.workflow_orchestrator import StreamlitWorkflowOrchestrator
0017: 
0018: 
0019: @st.cache_resource
0020: def get_orchestrator() -> StreamlitWorkflowOrchestrator:
0021:     """ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–
0022: 
0023:     è¨­è¨ˆåˆ¤æ–­:
0024:     - @st.cache_resourceã§ã‚¢ãƒ—ãƒªå…¨ä½“ã§å…±æœ‰
0025:     - Streamlitå†å®Ÿè¡Œæ™‚ã‚‚æ°¸ç¶šåŒ–
0026: 
0027:     Returns:
0028:         StreamlitWorkflowOrchestrator: æ°¸ç¶šåŒ–ã•ã‚ŒãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
0029: 
0030:     """
0031:     di_container = DIContainer()
0032:     return StreamlitWorkflowOrchestrator(di_container)
0033: 
0034: 
0035: def initialize_session_state() -> None:
0036:     """ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®åˆæœŸåŒ–
0037: 
0038:     TDD Blue Phase: ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ç®¡ç†ã®è²¬å‹™åˆ†é›¢
0039: 
0040:     è¨­è¨ˆåˆ¤æ–­:
0041:     - ä¾å­˜æ€§é€†è»¢: SessionStateManager ã«å§”è­²
0042:     - å˜ä¸€è²¬ä»»åŸå‰‡: åˆæœŸåŒ–ã®çµ±æ‹¬ã®ã¿
0043:     - ä¿å®ˆæ€§: çŠ¶æ…‹ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯ã®ä¸€å…ƒåŒ–
0044:     """
0045:     from src.presentation.session_state_manager import initialize_all_session_states
0046: 
0047:     initialize_all_session_states()  # False: ãƒãƒ£ãƒƒãƒˆ, True: ãƒ•ã‚¡ã‚¤ãƒ«
0048: 
0049: 
0050: def show_file_upload_ui() -> bool:
0051:     """ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰UIã®è¡¨ç¤º
0052: 
0053:     TDD Blue Phase: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ»è²¬å‹™åˆ†é›¢ãƒ»å‹å®‰å…¨æ€§
0054: 
0055:     è¨­è¨ˆåˆ¤æ–­:
0056:     - å˜ä¸€è²¬ä»»åŸå‰‡: UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®çµ±åˆã®ã¿
0057:     - ä¾å­˜æ€§é€†è»¢: ãƒ•ã‚¡ã‚¤ãƒ«ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã«å§”è­²
0058:     - å‹å®‰å…¨æ€§: æ˜ç¤ºçš„booleanæˆ»ã‚Šå€¤
0059:     - çŠ¶æ…‹ç®¡ç†åˆ†é›¢: SessionStateManagerä½¿ç”¨
0060: 
0061:     Returns:
0062:         bool: ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå ´åˆTrue
0063: 
0064:     Raises:
0065:         ãªã— - UIå±¤ã§ã¯ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ãªã„è¨­è¨ˆ
0066: 
0067:     """
0068:     from src.presentation.components.file_browser import (
0069:         render_file_browser,
0070:         validate_uploaded_file,
0071:     )
0072:     from src.presentation.session_state_manager import SessionStateManager
0073: 
0074:     uploaded_file = render_file_browser()
0075: 
0076:     if uploaded_file is not None and validate_uploaded_file(uploaded_file):
0077:         SessionStateManager.set_uploaded_file(uploaded_file)
0078:         SessionStateManager.set_file_mode(True)
0079:         return True
0080: 
0081:     return False
0082: 
0083: 
0084: def handle_file_uploaded() -> None:
0085:     """ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾Œã®å‡¦ç†
0086: 
0087:     TDD Blue Phase: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ãƒ»è²¬å‹™åˆ†é›¢
0088: 
0089:     è¨­è¨ˆåˆ¤æ–­:
0090:     - å˜ä¸€è²¬ä»»åŸå‰‡: ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸæ™‚ã®é€šçŸ¥ã®ã¿
0091:     - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°: None ãƒã‚§ãƒƒã‚¯ã¨å®‰å…¨ãªå±æ€§ã‚¢ã‚¯ã‚»ã‚¹
0092:     - ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£: æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
0093:     - çŠ¶æ…‹ç®¡ç†åˆ†é›¢: SessionStateManagerä½¿ç”¨
0094: 
0095:     Raises:
0096:         ãªã— - UIå±¤ã§ã®ä¾‹å¤–ã¯é©åˆ‡ã«ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
0097: 
0098:     """
0099:     from src.presentation.session_state_manager import SessionStateManager
0100: 
0101:     uploaded_file = SessionStateManager.get_uploaded_file()
0102: 
0103:     if uploaded_file is not None:
0104:         try:
0105:             file_name = uploaded_file.name
0106:             st.success(f"ãƒ•ã‚¡ã‚¤ãƒ« '{file_name}' ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ")
0107: 
0108:             # ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚ŒãŸã“ã¨ã‚’ç¤ºã™
0109:             SessionStateManager.set_selected_file_path(file_name)
0110:             SessionStateManager.set_file_mode(True)
0111:         except AttributeError:
0112:             # ãƒ•ã‚¡ã‚¤ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã« name å±æ€§ãŒãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
0113:             st.error("ãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ")
0114:             SessionStateManager.set_uploaded_file(None)
0115:             SessionStateManager.set_file_mode(False)
0116: 
0117: 
0118: def main() -> None:
0119:     """ãƒ¡ã‚¤ãƒ³UIé–¢æ•°
0120: 
0121:     è¨­è¨ˆåˆ¤æ–­:
0122:     - é–¢æ•°ãƒ™ãƒ¼ã‚¹ã®æ§‹æˆï¼ˆStreamlitã®æ¨å¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
0123:     - ãƒˆãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®èª­ã¿ã‚„ã™ã„æ§‹é€ 
0124:     """
0125:     # ãƒšãƒ¼ã‚¸è¨­å®š
0126:     st.set_page_config(
0127:         page_title="DataAnalysisAgent",
0128:         page_icon="ğŸ“Š",
0129:         layout="wide",
0130:         initial_sidebar_state="expanded",
0131:     )
0132: 
0133:     # ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹åˆæœŸåŒ–
0134:     initialize_session_state()
0135: 
0136:     # ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿å–å¾—
0137:     orchestrator = get_orchestrator()
0138:     session_id = st.session_state.session_id
0139: 
0140:     # ã‚¿ã‚¤ãƒˆãƒ«
0141:     st.title("ğŸ“Š DataAnalysisAgent")
0142:     st.markdown("AIã‚’æ´»ç”¨ã—ãŸãƒ‡ãƒ¼ã‚¿åˆ†æè‡ªå‹•åŒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ")
0143: 
0144:     # ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
0145:     st.markdown("---")
0146: 
0147:     # ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
0148:     st.subheader("ğŸ“ ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«")
0149:     uploaded_file = render_file_browser()
0150: 
0151:     # ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå ´åˆã®å‡¦ç†
0152:     if uploaded_file:
0153:         st.success(f"âœ… ãƒ•ã‚¡ã‚¤ãƒ« '{uploaded_file.name}' ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ")
0154: 
0155:         # ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã«ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’ä¿å­˜
0156:         st.session_state.uploaded_file = uploaded_file
0157:         st.session_state.uploaded_file_name = uploaded_file.name
0158: 
0159:     # ãƒãƒ£ãƒƒãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢
0160:     st.subheader("ğŸ’¬ åˆ†æè¦æ±‚")
0161: 
0162:     user_input = st.text_input(
0163:         "åˆ†æã—ãŸã„å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:",
0164:         placeholder="ä¾‹: ãƒ‡ãƒ¼ã‚¿ã‚’è©³ã—ãåˆ†æã—ã¦ã€æ•£å¸ƒå›³ã¨ç›¸é–¢è¡Œåˆ—ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„",
0165:         disabled=st.session_state.job_running,
0166:         key="user_input",
0167:     )
0168: 
0169:     col1, col2 = st.columns([1, 5])
0170: 
0171:     with col1:
0172:         submit_button = st.button(
0173:             "ğŸš€ åˆ†æé–‹å§‹",
0174:             disabled=st.session_state.job_running or not user_input,
0175:             use_container_width=True,
0176:         )
0177: 
0178:     with col2:
0179:         if st.session_state.job_running:
0180:             st.info("â³ åˆ†æå®Ÿè¡Œä¸­...")
0181: 
0182:     # åˆ†æé–‹å§‹å‡¦ç†
0183:     if submit_button and user_input:
0184:         result = orchestrator.process_user_message_async(user_input, session_id)
0185: 
0186:         if result == "STARTED":
0187:             st.session_state.job_running = True
0188:             st.session_state.user_messages.append(user_input)
0189:             st.success("âœ… åˆ†æã‚’é–‹å§‹ã—ã¾ã—ãŸ")
0190:             st.rerun()
0191:         else:
0192:             st.error(f"âŒ {result}")
0193: 
0194:     # é€²æ—ç¢ºèª
0195:     if st.session_state.job_running:
0196:         status = orchestrator.get_job_status(session_id)
0197: 
0198:         if status["status"] == "progress":
0199:             # é€²æ—è¡¨ç¤º
0200:             progress = status.get("step", 0) / status.get("total", 1)
0201:             st.progress(progress, text=status.get("message", "å‡¦ç†ä¸­..."))
0202: 
0203:             # 1ç§’å¾Œã«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
0204:             import time
0205: 
0206:             time.sleep(1)
0207:             st.rerun()
0208: 
0209:         elif status["status"] == "completed":
0210:             # å®Œäº†
0211:             st.session_state.job_running = False
0212:             st.session_state.analysis_result = status.get("result")
0213:             st.session_state.assistant_messages.append("åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸ")
0214:             st.success("âœ… åˆ†æå®Œäº†ï¼")
0215:             st.rerun()
0216: 
0217:         elif status["status"] == "error":
0218:             # ã‚¨ãƒ©ãƒ¼
0219:             st.session_state.job_running = False
0220:             error_msg = status.get("error", "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼")
0221:             st.session_state.assistant_messages.append(f"ã‚¨ãƒ©ãƒ¼: {error_msg}")
0222:             st.error(f"âŒ ã‚¨ãƒ©ãƒ¼: {error_msg}")
0223: 
0224:     # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´è¡¨ç¤º
0225:     if st.session_state.user_messages or st.session_state.assistant_messages:
0226:         st.markdown("---")
0227:         st.subheader("ğŸ“ å±¥æ­´")
0228: 
0229:         # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’äº¤äº’ã«è¡¨ç¤º
0230:         max_len = max(
0231:             len(st.session_state.user_messages),
0232:             len(st.session_state.assistant_messages),
0233:         )
0234: 
0235:         for i in range(max_len):
0236:             if i < len(st.session_state.user_messages):
0237:                 with st.chat_message("user"):
0238:                     st.write(st.session_state.user_messages[i])
0239: 
0240:             if i < len(st.session_state.assistant_messages):
0241:                 with st.chat_message("assistant"):
0242:                     st.write(st.session_state.assistant_messages[i])
0243: 
0244:     # çµæœè¡¨ç¤º
0245:     if st.session_state.analysis_result:
0246:         st.markdown("---")
0247:         st.subheader("ğŸ“Š åˆ†æçµæœ")
0248:         st.json(st.session_state.analysis_result)
0249: 
0250:     # ã‚µã‚¤ãƒ‰ãƒãƒ¼: ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±
0251:     with st.sidebar:
0252:         st.header("â„¹ï¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±")
0253:         st.text(f"Session ID: {session_id[:8]}...")
0254:         st.text(f"å®Ÿè¡Œä¸­: {'ã¯ã„' if st.session_state.job_running else 'ã„ã„ãˆ'}")
0255: 
0256:         # ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±
0257:         if (
0258:             hasattr(st.session_state, "uploaded_file_name")
0259:             and st.session_state.uploaded_file_name
0260:         ):
0261:             st.markdown("---")
0262:             st.subheader("ğŸ“„ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«")
0263:             st.text(f"ãƒ•ã‚¡ã‚¤ãƒ«å: {st.session_state.uploaded_file_name}")
0264: 
0265:         if st.button("ğŸ”„ ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒªã‚»ãƒƒãƒˆ"):
0266:             # ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
0267:             for key in list(st.session_state.keys()):
0268:                 del st.session_state[key]
0269:             st.rerun()
0270: 
0271: 
0272: if __name__ == "__main__":
0273:     main()
